// Prisma Schema for 健康计算器
// 优化版本 - 针对 Neon PostgreSQL

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.1.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户角色枚举
enum UserRole {
  ADMIN      // 管理员
  USER       // 普通用户
}

// 用户表 (自定义认证)
model User {
  id                String    @id @default(uuid())
  email             String    @unique
  password          String    // bcrypt 加密
  username          String    @unique
  avatar            String?
  role              UserRole  @default(USER)      // 用户角色，默认为普通用户
  isActive          Boolean   @default(true)      // 账户是否激活
  emailVerified     Boolean   @default(false)     // 邮箱是否已验证
  verificationToken String?   @unique             // 邮箱验证令牌
  tokenExpiry       DateTime?                     // 令牌过期时间
  resetToken        String?   @unique             // 密码重置令牌
  resetTokenExpiry  DateTime?                     // 重置令牌过期时间
  lastLoginAt       DateTime?                     // 最后登录时间
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // 用户个人信息
  profile UserProfile?
  
  // 计算历史记录
  bmiRecords             BMIRecord[]
  bmrRecords             BMRRecord[]
  bodyFatRecords         BodyFatRecord[]
  waistHipRecords        WaistHipRecord[]
  bloodPressureRecords   BloodPressureRecord[]
  targetHeartRateRecords TargetHeartRateRecord[]
  sliRecords             SLIRecord[]
  calorieRecords         CalorieRecord[]

  @@map("users")
  @@index([role, isActive])           // 复合索引：管理员查询活跃用户
  @@index([isActive, createdAt])      // 复合索引：按注册时间查询活跃用户
  @@index([lastLoginAt])              // 索引：查询最近登录
  @@index([createdAt])                // 索引：按注册时间排序
  @@index([verificationToken])        // 索引：快速查找验证令牌
  @@index([resetToken])               // 索引：快速查找密码重置令牌
}

// 用户个人资料
model UserProfile {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  gender    String?  // male, female
  birthDate DateTime?
  height    Float?   // cm
  weight    Float?   // kg
  
  updatedAt DateTime @updatedAt

  @@map("user_profiles")
}

// BMI 计算记录
model BMIRecord {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  gender    String
  height    Float    // cm
  weight    Float    // kg
  bmi       Float
  advice    String   @db.Text  // 优化：使用 TEXT 类型存储长文本
  
  createdAt DateTime @default(now())

  @@map("bmi_records")
  @@index([userId, createdAt(sort: Desc)])  // 优化：降序索引，最新记录优先
  @@index([createdAt(sort: Desc)])          // 索引：全局最新记录查询
}

// BMR 基础代谢率记录
model BMRRecord {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  gender        String
  age           Int
  height        Float    // cm
  weight        Float    // kg
  activityLevel Float
  bmr           Float
  calorieNeeds  Float
  
  createdAt     DateTime @default(now())

  @@map("bmr_records")
  @@index([userId, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}

// 体脂率记录
model BodyFatRecord {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  gender            String
  age               Int
  height            Float    // cm
  weight            Float    // kg
  waist             Float    // cm
  hip               Float    // cm
  bodyFatPercentage Float
  advice            String   @db.Text
  
  createdAt         DateTime @default(now())

  @@map("body_fat_records")
  @@index([userId, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}

// 腰臀比记录
model WaistHipRecord {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  gender    String
  waist     Float    // cm
  hip       Float    // cm
  ratio     Float
  advice    String   @db.Text
  
  createdAt DateTime @default(now())

  @@map("waist_hip_records")
  @@index([userId, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}

// 血压记录
model BloodPressureRecord {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  systolic  Int      // 收缩压
  diastolic Int      // 舒张压
  advice    String   @db.Text
  
  createdAt DateTime @default(now())

  @@map("blood_pressure_records")
  @@index([userId, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}

// 目标心率记录
model TargetHeartRateRecord {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  age          Int
  maxHeartRate Int
  warmUpRange  String   @db.VarChar(50)
  fatBurnRange String   @db.VarChar(50)
  cardioRange  String   @db.VarChar(50)
  
  createdAt    DateTime @default(now())

  @@map("target_heart_rate_records")
  @@index([userId, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}

// 心脏负荷指数记录
model SLIRecord {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  age               Int
  exerciseHeartRate Int
  restingHeartRate  Int
  duration          Int      // minutes
  sli               Float
  advice            String   @db.Text
  
  createdAt         DateTime @default(now())

  @@map("sli_records")
  @@index([userId, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}

// 卡路里需求记录
model CalorieRecord {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  gender        String
  age           Int
  height        Float
  weight        Float
  activityLevel Float
  maintenance   Int
  deficit       Int
  surplus       Int
  
  createdAt     DateTime @default(now())

  @@map("calorie_records")
  @@index([userId, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}

