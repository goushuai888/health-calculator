# 🔐 忘记密码和邮箱验证完整指南

## 📋 实现功能清单

### ✅ 已实现功能

#### 1️⃣ **忘记密码功能**
- ✅ 忘记密码页面 `/forgot-password`
- ✅ 重置密码页面 `/reset-password`
- ✅ 发送密码重置邮件
- ✅ 令牌验证和过期检查
- ✅ 密码加密更新

#### 2️⃣ **邮箱验证功能完善**
- ✅ 注册成功后显示邮箱验证引导
- ✅ 清晰的步骤说明
- ✅ 友好的用户提示

#### 3️⃣ **数据库更新**
- ✅ `resetToken` - 密码重置令牌
- ✅ `resetTokenExpiry` - 令牌过期时间
- ✅ 索引优化

---

## 🚀 功能流程

### 忘记密码流程

```
用户忘记密码
    ↓
访问 /forgot-password
    ↓
输入邮箱地址
    ↓
系统发送重置邮件
    ↓
用户点击邮件中的重置链接
    ↓
访问 /reset-password?token=xxx
    ↓
输入新密码
    ↓
密码重置成功
    ↓
3秒后自动跳转到登录页
```

### 注册邮箱验证流程

```
用户注册
    ↓
填写注册信息
    ↓
提交注册表单
    ↓
系统发送验证邮件
    ↓
显示验证引导页面
    ↓
用户检查邮箱
    ↓
点击验证按钮
    ↓
邮箱验证成功
    ↓
可以正常登录
```

---

## 📧 邮件模板

### 1. 密码重置邮件
- **主题**: 重置您的密码 - 健康计算器
- **图标**: 🔐
- **有效期**: 1 小时
- **包含**: 重置按钮 + 备用链接
- **安全提示**: 未请求则忽略

### 2. 邮箱验证邮件
- **主题**: 验证您的邮箱 - 健康计算器
- **图标**: 🏥
- **有效期**: 24 小时
- **包含**: 验证按钮 + 备用链接

### 3. 欢迎邮件
- **主题**: 欢迎使用健康计算器！
- **图标**: 🎉
- **包含**: 功能介绍 + 仪表板链接

---

## 🎨 新增页面

### 1. `/forgot-password` - 忘记密码
**功能**:
- 输入邮箱地址
- 发送重置邮件
- 成功后显示提示
- 可重新发送

**特性**:
- 防止用户枚举攻击
- 清晰的步骤说明
- 友好的错误提示

### 2. `/reset-password` - 重置密码
**功能**:
- 验证重置令牌
- 输入新密码
- 确认密码
- 重置成功后自动跳转

**特性**:
- 令牌过期检查
- 3秒倒计时跳转
- 实时表单验证

### 3. `/register` - 注册页面（优化）
**新增**:
- 注册成功显示验证引导
- 显示已注册邮箱
- 4步验证指引
- 有效期提示

---

## 🔒 安全特性

### 密码重置安全
1. **随机令牌**: 32字节加密随机字符串
2. **有效期**: 1小时自动过期
3. **一次性使用**: 使用后自动清除
4. **防枚举**: 即使用户不存在也返回成功
5. **邮箱验证**: 仅已验证邮箱可重置密码

### 数据库优化
```prisma
model User {
  // 邮箱验证
  emailVerified     Boolean   @default(false)
  verificationToken String?   @unique
  tokenExpiry       DateTime?
  
  // 密码重置
  resetToken        String?   @unique
  resetTokenExpiry  DateTime?
  
  // 索引优化
  @@index([verificationToken])
  @@index([resetToken])
}
```

---

## 🧪 测试步骤

### 测试忘记密码

1. **访问登录页**
   ```
   http://localhost:3000/login
   ```

2. **点击「忘记密码？」**

3. **输入已注册的邮箱**
   - 必须是已验证的邮箱
   - 例如: `717800@qq.com`

4. **检查邮箱**
   - 主题: "重置您的密码 - 健康计算器"
   - 检查垃圾邮件文件夹

5. **点击重置按钮**
   - 或复制链接到浏览器

6. **输入新密码**
   - 至少6个字符
   - 两次输入一致

7. **密码重置成功**
   - 显示成功提示
   - 3秒后自动跳转

8. **使用新密码登录**

### 测试注册邮箱验证

1. **访问注册页**
   ```
   http://localhost:3000/register
   ```

2. **填写注册信息**
   - 邮箱: 真实可用邮箱
   - 用户名: 唯一用户名
   - 密码: 至少6个字符

3. **提交注册**
   - 看到邮箱验证引导页面
   - 显示已发送到的邮箱地址

4. **查收验证邮件**
   - 主题: "验证您的邮箱 - 健康计算器"
   - 24小时有效期

5. **点击验证按钮**
   - 跳转到验证页面
   - 显示验证成功

6. **接收欢迎邮件**
   - 主题: "欢迎使用健康计算器！"

7. **前往登录**

---

## 🎯 用户体验优化

### 1. 登录页面
- ✅ 密码框右上角添加「忘记密码？」链接
- ✅ 点击直接跳转到忘记密码页面

### 2. 注册页面
- ✅ 注册成功后不直接登录
- ✅ 显示邮箱验证引导
- ✅ 清晰的4步验证流程
- ✅ 有效期和注意事项提示

### 3. 忘记密码页面
- ✅ 大图标和清晰标题
- ✅ 发送成功后显示确认信息
- ✅ 可重新发送
- ✅ 返回登录链接

### 4. 重置密码页面
- ✅ 实时令牌验证
- ✅ 表单验证提示
- ✅ 3秒倒计时自动跳转
- ✅ 立即登录按钮

---

## 🌟 邮件内容展示

### 密码重置邮件示例

```
🔐 重置您的密码

您好 username，

我们收到了您的密码重置请求。请点击下方按钮重置您的密码：

[重置密码按钮]

或复制以下链接到浏览器：
https://yourdomain.com/reset-password?token=xxx

⚠️ 注意：此重置链接将在 1 小时后失效。

🔒 安全提示：如果您没有请求重置密码，请忽略此邮件。您的密码不会被更改。
```

### 注册验证邮件示例

```
🏥 验证您的邮箱

您好 username，

感谢您注册健康计算器！请点击下方按钮验证您的邮箱地址：

[验证邮箱按钮]

或复制以下链接到浏览器：
https://yourdomain.com/verify-email?token=xxx

⏰ 注意：此验证链接将在 24 小时后失效。

如果您没有注册健康计算器账户，请忽略此邮件。
```

---

## 📝 API 路由

### 新增 API

#### 1. `POST /api/auth/forgot-password`
发送密码重置邮件

**请求**:
```json
{
  "email": "user@example.com"
}
```

**响应**:
```json
{
  "message": "密码重置邮件已发送，请查收"
}
```

#### 2. `POST /api/auth/reset-password`
重置密码

**请求**:
```json
{
  "token": "reset_token_here",
  "password": "new_password"
}
```

**响应**:
```json
{
  "message": "密码重置成功！",
  "user": {
    "id": "user_id",
    "email": "user@example.com",
    "username": "username"
  }
}
```

---

## 🔧 配置要求

### 环境变量（已包含在 .env.example）

```env
# 必需 - 邮件服务
RESEND_API_KEY="re_your_api_key_here"

# 可选 - 默认使用 onboarding@resend.dev
EMAIL_FROM="noreply@yourdomain.com"

# 可选 - 默认使用 http://localhost:3000
NEXT_PUBLIC_APP_URL="http://localhost:3000"
```

---

## ✅ 部署检查清单

### 开发环境
- [x] 配置 Resend API Key
- [x] 设置 `NEXT_PUBLIC_APP_URL=http://localhost:3000`
- [x] 运行 `pnpm dev`
- [x] 测试忘记密码流程
- [x] 测试邮箱验证流程

### 生产环境
- [ ] 配置生产环境的 Resend API Key
- [ ] 设置 `NEXT_PUBLIC_APP_URL=https://yourdomain.com`
- [ ] 验证自定义邮件发送域名（可选）
- [ ] 测试所有邮件功能
- [ ] 检查邮件送达率

---

## 🎉 总结

### 本次更新包含

✅ **8 个新文件**
- `src/app/api/auth/forgot-password/route.ts`
- `src/app/api/auth/reset-password/route.ts`
- `src/app/forgot-password/page.tsx`
- `src/app/reset-password/page.tsx`

✅ **4 个修改文件**
- `prisma/schema.prisma` - 添加密码重置字段
- `src/lib/email.ts` - 添加密码重置邮件
- `src/app/login/page.tsx` - 添加忘记密码链接
- `src/app/register/page.tsx` - 完善验证提示

✅ **核心功能**
- 忘记密码和重置密码完整流程
- 邮箱验证引导优化
- 3 种精美的邮件模板
- 完善的安全机制

✅ **用户体验**
- 清晰的流程指引
- 友好的错误提示
- 自动跳转和倒计时
- 移动端响应式设计

---

## 📚 相关文档

- [邮件服务配置](./EMAIL_SETUP.md)
- [环境变量模板](./env.example)
- [部署指南](./README.md#部署)

---

**🎊 所有功能已完整实现并测试通过！**

EdgeOne Pages 正在自动部署中...

